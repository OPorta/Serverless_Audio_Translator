AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Lambda used to send transcriptions to SNS when uploaded to an S3 bucket.
Parameters:
  TranscriptionsBucket:
    Type: String
    Description: Transcriptions bucket

Resources:
  TranscriptionsSNS:
    Type: 'AWS::SNS::Topic'

  SendTranscriptionToSNS:
    Type: AWS::Serverless::Function
    Properties:
      Handler: audio-translator-send-audio-to-transcribe.handler
      Runtime: nodejs12.x
      Events:
        TranscriptionUpdated:
          Type: S3
          Properties:
            Bucket: !Ref TranscriptionsBucket
            Events: s3:ObjectCreated:*
      Environment:
        Variables:
          OUTPUT_SNS_TOPIC: !Ref TranscriptionsSNS
      Policies:
        - Statement:
          - Effect: Allow
            Resource: !GetAtt TranscriptionsBucket.Arn
            Action:
              - s3:GetObject
          - Effect: Allow
            Resource: !Ref TranscriptionsSNS
            Action:
              - sns:Publish